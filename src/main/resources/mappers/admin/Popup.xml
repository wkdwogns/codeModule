<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nexon.admin.popup.dao.AdminPopupDao">

    <select id="selectPopupList" parameterType="com.nexon.admin.popup.dto.req.SelectPopupListReq" resultType="com.nexon.admin.popup.dto.model.PopupListVO">
        SELECT @rownum:=@rownum+1 POPUP_NO
              , A.*
        FROM (
            SELECT
                A.POPUP_SEQ
                , A.POPUP_NM
                , A.VIEW_YN
                , DATE_FORMAT(A.VIEW_ST_DT, '%Y.%m.%d %H:%i') VIEW_ST_DT
                , DATE_FORMAT(A.VIEW_END_DT, '%Y.%m.%d %H:%i') VIEW_END_DT
                , A.VIEW_UNLIMIT_YN
                , A.TARGET_URL
                , A.TARGET_YN
                , A.FILE_GRP_SEQ
                , B.FILE_SEQ
                , B.ORG_FILE_NM
                , B.SYS_FILE_NM
                , B.FILE_PATH
            FROM
                TB_POPUP A
                LEFT OUTER JOIN TB_FILE B ON A.FILE_GRP_SEQ = B.FILE_GRP_SEQ AND IFNULL(B.DEL_YN, 'N') = 'N'
            WHERE IFNULL(A.DEL_YN, 'N') = 'N'
            ORDER BY A.CRE_DT DESC
        ) A,
        (SELECT @rownum:=0) RN
        ORDER BY POPUP_NO
        LIMIT ${startRow}, ${cntPerPage}
    </select>

    <select id="selectPopupListCnt" parameterType="com.nexon.admin.notice.req.SelectNoticeReq" resultType="int">
        SELECT
            count(*)
        FROM
            TB_POPUP A
        WHERE IFNULL(A.DEL_YN, 'N') = 'N'
    </select>

    <select id="selectPopupDetail" parameterType="com.nexon.admin.popup.dto.req.PopupDtlReq" resultType="com.nexon.admin.popup.dto.model.PopupDtlVO">
        SELECT
            A.POPUP_SEQ
            , A.POPUP_NM
            , A.VIEW_YN
            , DATE_FORMAT(A.VIEW_ST_DT, '%Y.%m.%d %H:%i') VIEW_ST_DT
            , DATE_FORMAT(A.VIEW_END_DT, '%Y.%m.%d %H:%i') VIEW_END_DT
            , A.VIEW_ST_DT
            , A.VIEW_END_DT
            , A.VIEW_UNLIMIT_YN
            , A.TARGET_URL
            , A.TARGET_YN
            , A.FILE_GRP_SEQ
        FROM TB_POPUP A
        WHERE
            A.POPUP_SEQ = #{popupSeq}
    </select>

    <insert id="insertPopup" parameterType="com.nexon.admin.popup.dto.req.InsertPopupReq">
        INSERT INTO TB_POPUP (
            POPUP_NM
            , VIEW_YN
            , VIEW_ST_DT
            , VIEW_END_DT
            , VIEW_UNLIMIT_YN
            , TARGET_URL
            , TARGET_YN
            , FILE_GRP_SEQ
            , DEL_YN
            , CRE_DT
            , CRE_ID
            , UPD_DT
            , UPD_ID
        ) VALUES (
            #{popupNm}
            , #{viewYn}
            , #{viewStDt}
            , #{viewEndDt}
            , #{viewUnlimitYn}
            , #{targetUrl}
            , #{targetYn}
            , #{fileGrpSeq}
            , 'N'
            , NOW()
            , #{userSeq}
            , NOW()
            , #{userSeq}
        )
    </insert>

    <update id="updatePopup" parameterType="com.nexon.admin.popup.dto.req.UpdatePopupReq">
        UPDATE
            TB_POPUP
        SET
            POPUP_NM = #{popupNm}
            , VIEW_YN = #{viewYn}
            , VIEW_ST_DT = #{viewStDt}
            , VIEW_END_DT = #{viewEndDt}
            , VIEW_UNLIMIT_YN = #{viewUnlimitYn}
            , TARGET_URL = #{targetUrl}
            , TARGET_YN = #{targetYn}
            <if test="fileGrpSeq != null and fileGrpSeq != 0">
                , FILE_GRP_SEQ=#{fileGrpSeq}
            </if>
            , UPD_DT = now()
            , UPD_ID = #{userSeq}
        WHERE
            POPUP_SEQ = #{popupSeq}
    </update>


    <update id="deletePooup" parameterType="com.nexon.admin.popup.dto.req.PopupDtlReq">
        UPDATE
            TB_POPUP
        SET
            DEL_YN = 'Y'
        WHERE
            POPUP_SEQ = #{popupSeq}
    </update>

    <select id="selectPopupViewCnt" resultType="int">
        SELECT
            count(*)
        FROM
            TB_POPUP A
        WHERE IFNULL(A.DEL_YN, 'N') = 'N'
        AND VIEW_YN = 'Y'
    </select>

</mapper>
