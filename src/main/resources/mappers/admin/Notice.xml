<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nexon.admin.notice.dao.AdminNoticeDao">

    <select id="selectNotice" parameterType="com.nexon.admin.notice.req.SelectNoticeReq" resultType="com.nexon.admin.notice.model.NoticeListVO">
        SELECT
            @rownum:=@rownum+1 no
            ,n.NOTICE_SEQ
            ,n.TITLE
            ,n.IMPORTANT_YN
            ,n.VIEW_YN
            ,n.VIEW_UNLIMIT_YN
            ,n.NOTICE_TYPE
            ,n.FILE_GRP_SEQ
            ,DATE_FORMAT(n.VIEW_ST_DT, '%Y.%m.%d') VIEW_ST_DT
            ,DATE_FORMAT(n.VIEW_END_DT, '%Y.%m.%d') VIEW_END_DT
        FROM
            TB_NOTICE n,
            (SELECT @rownum:=0) rn
        WHERE
            n.DEL_YN='N'
            <if test="keyField=='Title'">
                and n.TITLE LIKE concat('%',#{keyWord},'%')
            </if>
            <if test="keyField=='Content'">
                and n.CONTENTS LIKE concat('%',#{keyWord},'%')
            </if>
            ORDER BY no DESC
            LIMIT ${startRow}, ${cntPerPage}
    </select>

    <select id="selectNoticeCnt" parameterType="com.nexon.admin.notice.req.SelectNoticeReq" resultType="int">
        SELECT
            count(*)
        FROM
            TB_NOTICE n
        WHERE
        n.DEL_YN='N'
        <if test="keyField=='Title'">
            and n.TITLE LIKE concat('%',#{keyWord},'%')
        </if>
        <if test="keyField=='Content'">
            and n.CONTENTS LIKE concat('%',#{keyWord},'%')
        </if>
    </select>

    <select id="selectNoticeDetail" parameterType="com.nexon.admin.notice.req.SelectNoticeDetailReq" resultType="com.nexon.admin.notice.res.SelectNoticeDetailRes">
        SELECT
            n.NOTICE_SEQ
            ,n.TITLE
            ,n.IMPORTANT_YN
            ,n.VIEW_YN
            ,n.CONTENTS
            ,n.FILE_GRP_SEQ
            ,n.IMG_GRP_SEQ
            ,n.VIEW_UNLIMIT_YN
            ,n.NOTICE_TYPE
            ,DATE_FORMAT(n.VIEW_ST_DT, '%Y-%m-%d %H:%i') VIEW_ST_DT
            ,DATE_FORMAT(n.VIEW_END_DT, '%Y-%m-%d %H:%i') VIEW_END_DT
        FROM
            TB_NOTICE n
        WHERE
            n.NOTICE_SEQ=#{seq}
    </select>

    <insert id="insertNotice" parameterType="com.nexon.admin.notice.req.InsertNoticeReq">
        INSERT INTO TB_NOTICE
        (
            TITLE
            ,IMPORTANT_YN
            ,VIEW_YN
            ,VIEW_ST_DT
            ,VIEW_END_DT
            ,VIEW_UNLIMIT_YN
            ,NOTICE_TYPE
            ,IMG_GRP_SEQ
            ,FILE_GRP_SEQ
            ,CONTENTS
            ,DEL_YN
            ,CRE_DT
            ,CRE_ID
            ,UPD_DT
            ,UPD_ID
        ) VALUES (
            #{title}
            ,#{importantYn}
            ,#{viewYn}
            ,#{viewStDt}
            ,#{viewEndDt}
            ,#{viewUnlimitYn}
            ,#{noticeType}
            ,#{imgGrpSeq}
            ,#{fileGrpSeq}
            ,#{contents}
            ,'N'
            ,now()
            ,#{userSeq}
            ,now()
            ,#{userSeq}
        )
    </insert>

    <update id="updateNotice" parameterType="com.nexon.admin.notice.req.UpdateNoticeReq">
        UPDATE
            TB_NOTICE
        SET
            TITLE=#{title}
            ,IMPORTANT_YN=#{importantYn}
            ,VIEW_YN=#{viewYn}
            ,VIEW_ST_DT=#{viewStDt}
            ,VIEW_END_DT=#{viewEndDt}
            ,VIEW_UNLIMIT_YN=#{viewUnlimitYn}
            ,NOTICE_TYPE=#{noticeType}
            <if test="imgGrpSeq!=null and imgGrpSeq!=''">
                ,IMG_GRP_SEQ=#{imgGrpSeq}
            </if>
            <if test="fileGrpSeq!=null and fileGrpSeq!=''">
                ,FILE_GRP_SEQ=#{fileGrpSeq}
            </if>
            ,CONTENTS=#{contents}
            ,UPD_DT=now()
            ,UPD_ID=#{userSeq}
        WHERE
            NOTICE_SEQ=#{seq}
    </update>


    <update id="deleteNotice" parameterType="com.nexon.admin.notice.req.DeleteNoticeReq">
        UPDATE
            TB_NOTICE
        SET
            DEL_YN='Y'
        WHERE
            NOTICE_SEQ=#{seq}
    </update>

    <select id="selectViewLimitCnt" resultType="int">
        SELECT COUNT(*)
        FROM TB_NOTICE A
        WHERE IFNULL(A.DEL_YN, 'N') = 'N'
          AND A.VIEW_YN = 'Y'
          AND A.IMPORTANT_YN = 'Y'
    </select>

    <update id="deleteFile" parameterType="com.nexon.admin.notice.req.DeleteNoticeImgReq">
        UPDATE
            TB_NOTICE
        SET
        <if test="type.equals('attach')">
            FILE_GRP_SEQ=null
        </if>
        <if test="type.equals('img')">
            IMG_GRP_SEQ=NULL
        </if>
        WHERE
            NOTICE_SEQ=#{seq}
    </update>



</mapper>
