<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nexon.admin.story.dao.AstoryDao">

    <select id="selectStory" parameterType="com.nexon.admin.story.req.SelectStoryReq" resultType="com.nexon.admin.story.model.StoryListVO">
        SELECT
            A.*
            , @rownum:=@rownum+1 no
        FROM (
            SELECT
                s.STORY_SEQ
                , s.CATEGORY
                , (SELECT USER_NAME FROM tb_user_profile WHERE USER_SEQ = s.CRE_ID) CRE_ID
                , (SELECT USER_NAME FROM tb_user_profile WHERE USER_SEQ = s.UPD_ID) UPD_ID
                , s.TITLE
                , s.IMPORTANT_YN
                , s.VIEW_UNLIMIT_YN
                , s.VIEW_YN
                , DATE_FORMAT(s.VIEW_ST_DT, '%Y.%m.%d') VIEW_ST_DT
                , DATE_FORMAT(s.VIEW_END_DT, '%Y.%m.%d') VIEW_END_DT
            FROM TB_STORY s
            WHERE IFNULL(s.DEL_YN, 'N') = 'N'
            <if test="keyField=='title'">
                and s.TITLE LIKE concat('%',#{keyword},'%')
            </if>
            <if test="keyField=='storyNm'">
                and s.STORY_NM LIKE concat('%',#{keyword},'%')
            </if>
            <if test="category!=null and category!=''">
                and s.CATEGORY = #{category}
            </if>
            ORDER BY s.CRE_DT DESC
        ) A,
        (SELECT @rownum:=0) rn
        ORDER BY no
        LIMIT ${startRow}, ${cntPerPage}
    </select>

    <select id="selectStoryCnt" parameterType="com.nexon.admin.story.req.SelectStoryReq" resultType="int">
        SELECT
            count(*)
        FROM
            TB_STORY s
        WHERE
            s.DEL_YN='N'
            <if test="keyField=='title'">
                and s.TITLE LIKE concat('%',#{keyword},'%')
            </if>
            <if test="keyField=='storyNm'">
                and s.STORY_NM LIKE concat('%',#{keyword},'%')
            </if>
            <if test="category!=null and category!=''">
                and s.CATEGORY = #{category}
            </if>
    </select>

    <select id="selectStoryDetail" parameterType="com.nexon.admin.story.req.SelectStoryDetailReq" resultType="com.nexon.admin.story.res.SelectStoryDetailRes">
        SELECT
            s.STORY_SEQ
              , s.CATEGORY
              , s.TITLE
              , s.IMPORTANT_YN
              , s.ORDER_NO
              , s.VIEW_YN
              , s.VIEW_UNLIMIT_YN
              , DATE_FORMAT(s.VIEW_ST_DT, '%Y-%m-%d %H:%i') VIEW_ST_DT
              , s.FILE_GRP_SEQ
              , s.IMG_GRP_SEQ
              , s.CONTENTS
        FROM
            TB_STORY s
        WHERE
            s.STORY_SEQ=#{seq}
            and s.DEL_YN='N'
    </select>

    <insert id="insertStory" parameterType="com.nexon.admin.story.req.InsertStoryReq">
        INSERT INTO TB_STORY
        (
            CATEGORY
            , STORY_NM
            , TITLE
            , IMPORTANT_YN
            , VIEW_YN
            , VIEW_UNLIMIT_YN
            , VIEW_ST_DT
            , ORDER_NO
            , FILE_GRP_SEQ
            , IMG_GRP_SEQ
            , CONTENTS
            , DEL_YN
            , CRE_DT
            , CRE_ID
            , UPD_DT
            , UPD_ID
        ) VALUES (
            #{category}
            , #{storyNm}
            , #{title}
            , #{importantYn}
            , #{viewYn}
            , #{viewUnlimitYn}
            , #{viewStDt}
            , #{orderNo}
            , #{fileGrpSeq}
            , #{imgGrpSeq}
            , #{contents}
            , 'N'
            , now()
            , #{userSeq}
            , now()
            , #{userSeq}
        )
    </insert>

    <update id="updateStory" parameterType="com.nexon.admin.story.req.UpdateStoryReq">
        UPDATE
            TB_STORY
        SET
            CATEGORY=#{category}
            , STORY_NM=#{storyNm}
            , TITLE=#{title}
            , IMPORTANT_YN=#{importantYn}
            , VIEW_YN=#{viewYn}
            , VIEW_UNLIMIT_YN=#{viewUnlimitYn}
            , VIEW_ST_DT=#{viewStDt}
            , ORDER_NO=#{orderNo}
            <if test="fileGrpSeq!=null and fileGrpSeq!=''">
                , FILE_GRP_SEQ=#{fileGrpSeq}
            </if>
            <if test="imgGrpSeq!=null and imgGrpSeq!=''">
                , IMG_GRP_SEQ=#{imgGrpSeq}
            </if>
            , CONTENTS=#{contents}
            , UPD_DT=now()
            , UPD_ID=#{userSeq}
        WHERE
            STORY_SEQ=#{seq}
    </update>

    <update id="deleteStory" parameterType="com.nexon.admin.story.req.DeleteStoryReq">
        UPDATE
            TB_STORY
        SET
            DEL_YN='Y'
        WHERE
            STORY_SEQ=#{seq}
    </update>

    <select id="selectViewLimitCnt" resultType="int">
        SELECT
            COUNT(*)
        FROM
            TB_STORY A
        WHERE
            IFNULL(A.DEL_YN, 'N') = 'N'
            AND A.VIEW_YN = 'Y'
            AND A.IMPORTANT_YN = 'Y'
    </select>

    <update id="deleteFile" parameterType="com.nexon.admin.story.req.DeleteStoryImgReq">
        UPDATE
            TB_STORY
        SET
            <if test="type.equals('attach')">
                FILE_GRP_SEQ=null
            </if>
            <if test="type.equals('img')">
                IMG_GRP_SEQ=NULL
            </if>
        WHERE
            STORY_SEQ=#{seq}
    </update>

</mapper>
