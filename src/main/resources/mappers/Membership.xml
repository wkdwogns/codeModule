<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nexon.membership.dao.MembershipDao">

    <insert id="insertUser" parameterType="map" useGeneratedKeys="true" keyProperty="userSeq">
        INSERT INTO
        TB_USER( MN_NO, USER_ID, EMAIL, USER_PWD, AUTHORITY, VERIFY_KEY, DEL_YN, CRE_ID, CRE_DT, UPD_ID, UPD_DT)
        VALUES( #{mnNo}, #{userId}, #{email}, #{userPwd}, #{authority}, NULL,'N', #{creId}, UTC_TIMESTAMP(), #{updId}, UTC_TIMESTAMP() )
    </insert>

    <insert id="insertProfile" parameterType="map">
        INSERT INTO
        TB_USER_PROFILE( USER_SEQ, NICK_NAME, USER_NAME, DEL_YN, CRE_ID, CRE_DT, UPD_ID, UPD_DT)
        VALUES(  #{userSeq}, #{nickName}, #{userName}, 'N',  #{userSeq}, UTC_TIMESTAMP(), #{userSeq}, UTC_TIMESTAMP() )
    </insert>


    <select id="getUserMnNoCnt" resultType="int" parameterType="int">
        SELECT count(USER_SEQ)
        FROM TB_USER
        where 1 = 1
        <if test='value != null and value != ""'>
            AND AUTHORITY = #{value}
        </if>
    </select>


    <select id="selectUserInfo" resultType="com.nexon.membership.dto.model.UserInfoVO" parameterType="map">
        SELECT A.USER_SEQ
        ,A.MN_NO
        ,A.USER_ID
        ,A.EMAIL
        ,A.USER_PWD
        ,A.AUTHORITY
        ,A.VERIFY_KEY
        ,A.VERIFY_KEY_SEND_DT
        ,A.CERTIFICATE_YN
        ,A.CRE_ID
        ,DATE_FORMAT(A.CRE_DT, '%Y-%m-%d') CRE_DT
        ,A.UPD_ID
        ,DATE_FORMAT(A.UPD_DT, '%Y-%m-%d') UPD_DT
        ,B.NICK_NAME
        ,B.USER_NAME
        FROM TB_USER A
        INNER JOIN TB_USER_PROFILE B ON A.USER_SEQ = B.USER_SEQ
        WHERE IFNULL(A.DEL_YN, 'N') = 'N'
            <if test="userSeq != null">
                AND A.USER_SEQ = #{userSeq}
            </if>
            <if test="userId != null">
                AND A.USER_ID = #{userId}
            </if>
    </select>

    <update id="updateUser" parameterType="map">
        update TB_USER

        set UPD_DT = UTC_TIMESTAMP()
        <if test="userId != null">
            , USER_ID = #{userId}
        </if>
        <if test="email != null">
            , EMAIL = #{email}
        </if>
        <if test="userPwd != null">
            , USER_PWD = #{userPwd}
        </if>
        <if test="authority != null">
            , AUTHORITY = #{authority}
        </if>
        <if test="verifyKey != null">
            , VERIFY_KEY = #{verifyKey}
        </if>
        <if test="verifyKey != null">
            , VERIFY_KEY_SEND_DT = DATE_ADD(UTC_TIMESTAMP(), INTERVAL #{emailVerifyEndTime} HOUR)
        </if>
        <if test="certificateYn != null">
            , CERTIFICATE_YN = #{certificateYn}
        </if>
        <if test="verifyPwdKey != null">
            , VERIFY_PWD_KEY = #{verifyPwdKey}
        </if>
        <if test="delYn != null">
            , DEL_YN = #{delYn}
        </if>
        <if test="updId != null">
            , UPD_ID = #{updId}
        </if>
        where USER_SEQ = #{userSeq}
    </update>


    <select id="selectUser" resultType="com.nexon.membership.dto.model.UserInfoVO" parameterType="map">
        SELECT USER_SEQ
        ,USER_ID
        ,EMAIL
        ,USER_PWD
        ,AUTHORITY
        ,VERIFY_KEY
        ,VERIFY_KEY_SEND_DT
        ,CERTIFICATE_YN
        ,DEL_YN
        ,CRE_ID
        ,CRE_DT
        ,UPD_ID
        ,UPD_DT
        FROM TB_USER
        WHERE DEL_YN ="N"
        <if test="userSeq != null">
            AND USER_SEQ = #{userSeq}
        </if>
        <if test="userId != null">
            AND USER_ID = #{userId}
        </if>
        <if test="email != null">
            AND EMAIL = #{email}
        </if>
        <if test="authority != null">
            AND AUTHORITY = #{authority}
        </if>
        <if test="verifyKey != null">
            AND VERIFY_KEY = #{verifyKey}
        </if>
        <if test="verifyKey != null">
            AND VERIFY_KEY_SEND_DT <![CDATA[ > ]]> UTC_TIMESTAMP()
        </if>
        <if test="delYn != null">
            AND DEL_YN = #{delYn}
        </if>
        <if test="creId != null">
            AND CRE_ID = #{creId}
        </if>
        <if test="creDt != null">
            AND CRE_DT = #{creDt}
        </if>
        <if test="updId != null">
            AND UPD_ID = #{updId}
        </if>
        <if test="updDt != null">
            AND UPD_DT = #{updDt}
        </if>
    </select>

    <select id="selectProfile" resultType="map" parameterType="map">
        SELECT USER_SEQ
            , FILE_GRP_SEQ
            , INTRODUCTION
            , HOMEPAGE_LINK
            , USER_NAME
            , NICK_NAME
            , NEWSLETTER_YN
            , DEL_YN
            , UPD_ID
        FROM TB_USER_PROFILE
        WHERE DEL_YN ="N"
        <if test="userSeq != null">
            AND USER_SEQ = #{userSeq}
        </if>
        <if test="fileGrpSeq != null">
            AND FILE_GRP_SEQ = #{fileGrpSeq}
        </if>
        <if test="introduction != null">
            AND INTRODUCTION = #{introduction}
        </if>
        <if test="homepageLink != null">
            AND HOMEPAGE_LINK = #{homepageLink}
        </if>
        <if test="nickName != null">
            AND NICK_NAME = #{nickName}
        </if>
        <if test="newsletterYn != null">
            AND NEWSLETTER_YN = #{newsletterYn}
        </if>
    </select>

    <update id="updateProfile" parameterType="map">
        update TB_USER_PROFILE
        set UPD_DT = UTC_TIMESTAMP()
        <if test="fileGrpSeq != null">
            , FILE_GRP_SEQ = #{fileGrpSeq}
        </if>
        <if test="introduction != null">
            , INTRODUCTION = #{introduction}
        </if>
        <if test="homepageLink != null">
            , HOMEPAGE_LINK = #{homepageLink}
        </if>
        <if test="nickName != null">
            , NICK_NAME = #{nickName}
        </if>
        <if test="userName != null">
            , USER_NAME = #{userName}
        </if>
        <if test="newsletterYn != null">
            , NEWSLETTER_YN = #{newsletterYn}
        </if>
        <if test="delYn != null">
            , DEL_YN = #{delYn}
        </if>
        <if test="updId != null">
            , UPD_ID = #{updId}
        </if>
        where USER_SEQ = #{userSeq}
    </update>


</mapper>
