<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/admin/layout/layout">
<head>
    <link rel="stylesheet" href="/admin/css/custom.css" crossorigin="anonymous">
</head>
<div class="content" layout:fragment="contents">
    <form id="userForm" >

        <table class="table writeTable">
            <caption>공지사항 관리</caption>
            <tbody>
            <!--<tr>
                <th>디바이스 타입<span class="required">*</span></th>
                <td>
                    <select id="devIdSelDeviceType">
                        <option value="P">PC</option>
                        <option value="M">모바일</option>
                        <option value="A">전체</option>
                    </select>
                </td>
            </tr>-->

            <!--<tr>
                <th>글유형<span class="required">*</span></th>
                <td>
                    <input type="radio" id="devIdRdoIsNoticeType1" name="noticeType" value="003001" class="devCssRdoIsView" checked="checked">
                    <label for="devIdRdoIsNoticeType1">일반 글</label>

                    <input type="radio" id="devIdRdoIsNoticeType2" name="noticeType" value="003002" class="devCssRdoIsView">
                    <label for="devIdRdoIsNoticeType2">공지사항</label>
                </td>
            </tr>-->

            <tr>
                <th>제목<span class="required">*</span></th>
                <td>
                    <input type="text" class="fullWidth" id="devIdTxtTitle" name="Title" maxlength="100" placeholder="2글자에서 100글자까지 입력 가능합니다. 문자 제한 없습니다.">
                </td>
            </tr>

            <tr>
                <th>노출여부<span class="required">*</span></th>
                <td>
                    <input type="radio" id="devIdRdoIsView1" name="viewYn" value="Y" class="devCssRdoIsView">
                    <label for="devIdRdoIsView1">노출</label>

                    <input type="radio" id="devIdRdoIsView2" name="viewYn" value="N" class="devCssRdoIsView" checked="checked">
                    <label for="devIdRdoIsView2">비노출</label>
                </td>
            </tr>

            <tr class="showTerm">
                <th>노출일자<span class="required">*</span></th>
                <td>
                    <div>
                        <label>
                            <input type="tel" id="devIdTxtSdt" name="Edt" maxlength="16" class="dt" style="width:150px;">
                            <span class="icon">
                                <i class="far fa-calendar-alt"></i>
                            </span>
                        </label>
                    </div>

                </td>
            </tr>

            <tr>
                <th>파일첨부</th>
                <td id="attach">
                    <input type="hidden" id="fileGrpSeq">
                    <input type="file" id="devIdTxtAttach" multiple="multiple">
                </td>
            </tr>

            <tr class="contentRow">
                <th>내용<span class="required">*</span></th>
                <td></td>
            </tr>

            </tbody>
        </table>

        <div id="summernote"></div>

        <!-- btnList -->
        <div id="btnList" class="btnList clearfix">
            <button type="button" id="btnSave" class="btn mainBtn">저장</button>
            <button type="button" class="btn blackBtn devCssBtnCancel">취소</button>
        </div>
        <!-- //btnList -->

    </form>

    <!-- summernote 관련 JS -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/summernote/0.8.12/summernote.css" rel="stylesheet">
    <script src="//cdnjs.cloudflare.com/ajax/libs/summernote/0.8.12/summernote.js"></script>
    <script>
        /* 서머노트 초기화 함수 */
        var setSummernote = function(){
            $('#summernote').summernote({
                minHeight:300,
                placeholder: '텍스트 입력 가능하며, 문자 제한 없습니다.\n' +
                '글자수 제한 없습니다.\n',
                fontNames: ['Gothic A1'],
                fontNamesIgnoreCheck: ['Gothic A1'],
                lineHeights: ['0.2', '0.3', '0.4', '0.5', '0.6', '0.8', '1.0', '1.2', '1.4', '1.5', '2.0', '3.0'],
                popover: {
                    image: [
                        ['image', ['resizeFull', 'resizeHalf', 'resizeQuarter']],
                        ['remove', ['removeMedia']]
                    ],
                    link: [
                        ['link', ['linkDialogShow', 'unlink']]
                    ],
                    table: [
                        ['add', ['addRowDown', 'addRowUp', 'addColLeft', 'addColRight']],
                        ['delete', ['deleteRow', 'deleteCol', 'deleteTable']],
                    ]
                },
                toolbar: [
                    ['font', ['bold', 'underline', 'italic', 'underline', 'clear']],
                    ['fontsize', ['fontsize']],
                    ['height', ['height']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview']]
                ],
                callbacks: {
                    onImageUpload: function(files, editor, welEditable) {
                        sendFile(files, this, welEditable); //에디터 이미지 업로드 처리
                    }
                },
            });

            $('#summernote').summernote('fontName', 'Gothic A1');
            $('#summernote').summernote('lineHeight', 1);
        }

        var fileArr=[];
        var deletedArr=[];
        $('#devIdTxtAttach').change(function (e) {
            fileCheck(e.target);
            var files = e.target.files;

            for(var i in files){
                if (typeof files[i] != 'object') { continue; }
                var rd = Math.floor(Math.random() * 100000) + 1;
                var obj={
                    fileSeq: 'T'+rd
                    ,orgFileNm: files[i].name
                }
                $('#devIdTxtAttach').after(setFileDOM(obj,'attach'));
                files[i].fileSeq=obj.fileSeq;
                fileArr.push(files[i]);
            }

            $(e.target).val('');
            console.log(fileArr);
        });

        $('.devCssBtnCancel').click(function(){
            location.href='/page/admin/notice/list';
        });

        $("#btnSave").click(function(){

            var data = new FormData();

            var stat = 'insert';
            var url = "/mapi/notice";
            var info = tms.getParameterByName("info");
            if(tms.isNotEmpty(info)){
                stat = 'update';
                url = "/mapi/notice/edit";
                data.append("seq", info );
            }

            var vi = [
                {id:'#devIdTxtTitle',rqd:true,msg:'게시물 제목을 작성하여 주세요.',min:2,max:100}
                ,{id:'#devIdTxtSdt',rqd:true,msg:'노출일자를 설정해 주세요.'}
                //,{id:'#devIdTxtImg',rqd:true,msg:'대표이미지를 첨부해주세요.',type:'file',pass:'update'}
                ,{id:'#summernote',rqd:true,msg:'게시물 내용을 작성하여 주세요.',type:'summerNote'}
            ];

            var dr = door(vi,stat);
            if(!dr)
                return ;

            if(!confirm("해당 내용으로 저장하시겠습니까?")) {
                return;
            }

            /* 이미지 삭제 */
            var editorDelImg = editorImg.slice();
            var contents = $('#summernote').summernote('code'); //에디터 내용 가져오기
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = contents;
            $.each($(tempDiv).find("img[data-filename]"), function(index, value) { //삭제된 이미지 비교 처리
                var nm = $(value).data("filename");
                var arrayIdx = editorDelImg.indexOf(nm);
                if(arrayIdx != -1){
                    editorDelImg.splice(arrayIdx,1);
                }
            });

            data.append("title", $('#devIdTxtTitle').val() );
            data.append("contents", contents );
            data.append("viewYn", $(":input:radio[name=viewYn]:checked").val() );
            data.append("viewStDt", $('#devIdTxtSdt').val() );
            data.append("importantYn", 'N' );
            data.append("noticeType", '003002');
            data.append("viewUnlimitYn", 'N' );
            data.append("editorDelImg", editorDelImg);

            if(fileArr.length>0) {
                for (var ii in fileArr) {
                    data.append("file", fileArr[ii]);
                }
            }

            if(deletedArr.length>0) {
                for (var ii in deletedArr) {
                    data.append("delete", deletedArr[ii]);
                }
            }

            var fileGrpSeq  = $('#fileGrpSeq').val();
            if( tms.isNotEmpty(fileGrpSeq) ){
                data.append( "fileGrpSeq" , fileGrpSeq );
            }

            tms.ajaxMulitpartHelper(url, data, null, function(result){
                if(result.code == 0){
                    tms.initInputTxt('#inputFrm');
                    alert("저장되었습니다");
                    location.href = "/page/admin/notice/list"
                } else if(result.code == 350) {
                    alert("최대 2개 중요게시글 노출을 초과하였습니다.");
                } else {
                    alert("저장중 에러가 발생하였습니다");
                }
            }, function(){
                alert("저장중 에러 발생");
            });
        });

        var editorImg = new Array();
        function sendFile(files, editor, welEditable) {
            var data = new FormData();
            for (var i = files.length - 1; i >= 0; i--) {
                data.append('file', files[i]);
            }

            data.append('category', 3 );

            tms.ajaxMulitpartHelper("/api/file/editor/imgs", data, null, function(result){
                if(tms.isNotEmpty(result.data.fileInfos)){
                    for(var i=0; i< result.data.fileInfos.length;i++){
                        var fileName = result.data.fileInfos[i].fileSysName;
                        editorImg.push(fileName);

                        $(editor).summernote('insertImage', result.data.fileInfos[i].fileUrl,function($image){
                            $image.attr('data-filename', fileName);
                            $image.css({'width':'50%'});
                        });
                    }
                }
            }, function(){ //실패 처리

            });
        }

        function detail(info){

            var params = { seq:info };

            tms.ajaxGetHelper('/mapi/notice/detail', params, null, function(rs) {

                if(rs.code==0){
                    var d = rs.data;

                    $('#devIdTxtTitle').val(tms.convertHtml(d.title));
                    $('input:radio[name=viewYn]:input[value='+d.viewYn+']').attr("checked",true);
                    $('#devIdTxtSdt').val(d.viewStDt);

                    $('#fileGrpSeq').val(d.fileGrpSeq);
                    if(d.flist!=null){
                        var fl =d.flist;
                        for(var i in fl){
                            $('#devIdTxtAttach').after(setFileDOM(fl[i],'attach'));
                        }
                    }

                    $('#summernote').summernote('code', d.contents );
                }
            }, function(){

            });

        }

        function setFileDOM(fl,type) {
            var html = ''+
                '<div id="fileNo'+fl.fileSeq+'" class="file">' +
                    '<input type="hidden" class="fileSeq" value="'+fl.fileSeq+'"/>'+
                        '<a href="#self" style="margin-right: 30px;">'+fl.orgFileNm+'</a>' ;
                        //api/file/download?fileSeq='+fl.fileSeq+'&category=3
                        if(type=='attach'){
                            html+='<a onclick="deleteFile(\''+fl.fileSeq+'\',\''+type+'\')"><img src="/front/images/common/btn_close_01.png" style="height: 15px;vertical-align: middle;"></a>';
                        }
                 html+='</div>';

            return html;
        }

        function deleteFile(no,type) {
            if(confirm('삭제하시겠습니까?')){

                if(no.indexOf('T')==-1){
                    deletedArr.push(no);
                }else{
                    fileArr=fileArr.filter(function(v){
                        if(v.fileSeq==no){
                            return false;
                        }
                        return true;
                    })
                }

                $('#fileNo'+no).remove();
                console.log(deletedArr);
            }
        }

        $(document).ready(function () {

            $('#devIdTxtSdt').datetimepicker({
                dateFormat: "yy-mm-dd"
                ,onClose: function() {
                    $('.note-toolbar').css({'zIndex':500});
                }
                ,beforeShow:function () {
                    $('.note-toolbar').css({'zIndex':0});
                }
            });


            var info = tms.getParameterByName("info");

            if(info!=null&&info!=''){
                detail(info);

                $('#btnList').append('<button type="button" class="btn grayBtn deleteBtn">삭제</button>');
                $('#btnList .deleteBtn').click(function(e){
                    e.preventDefault();
                    if(confirm('삭제하시겠습니까?')){
                        var info = tms.getParameterByName("info");
                        var data ={};
                        if(tms.isEmpty(info)){return ;}
                        data.seq=info;

                        tms.ajaxDeleteHelper('/mapi/notice', JSON.stringify(data), null, function(rs){
                            if(rs.code==0){
                                alert('삭제되었습니다.');
                                location.href='/page/admin/notice/list';
                            }
                        });

                    }

                });

            }

        });

        setSummernote();

    </script>
</div>
</html>