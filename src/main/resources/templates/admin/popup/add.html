<html lang="ko" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="/admin/layout/layout">
<div class="content" layout:fragment="contents">
    <form id="userForm" >
        <input type="hidden" id="devIdHdnSEQ" value="">

        <table class="table writeTable">
            <caption>메인 팝업 등록</caption>
            <tbody>
            <tr>
                <th>팝업명<span class="required">*</span></th>
                <td>
                    <input type="text" class="fullWidth" id="devIdTxtTitle" name="Title" maxlength="100" value="">
                </td>
            </tr>
            <tr>
                <th>노출여부<span class="required">*</span></th>
                <td>
                    <input type="radio" id="devIdRdoIsView1" name="viewYn" value="Y" class="devCssRdoIsView">
                    <label for="devIdRdoIsView1">노출</label>

                    <input type="radio" id="devIdRdoIsView2" name="viewYn" value="N" class="devCssRdoIsView" checked="checked">
                    <label for="devIdRdoIsView2">비노출</label>
                </td>
            </tr>

            <tr class="showTerm">
                <th>노출기간<span class="required">*</span></th>
                <td>
                    <div>
                        <label>
                            <input type="tel" id="devIdTxtSdt" name="Edt" maxlength="16" class="dt" style="width:150px;" readonly="readonly">
                            <span class="icon">
                                <i class="far fa-calendar-alt"></i>
                            </span>
                        </label>
                    </div>
                    <div class="div">
                        <p>~</p>
                    </div>
                    <div>
                        <label>
                            <input type="tel" id="devIdTxtEdt" name="Edt" maxlength="16" class="dt" style="width:150px;" readonly="readonly">
                            <span class="icon">
										<i class="far fa-calendar-alt"></i>
									</span>
                        </label>
                    </div>
                    <div class="limitChk pl30">
                        <input type="checkbox" id="unLimitYn" name="unLimitYn">
                        <label for="unLimitYn">무제한</label>
                    </div>
                </td>
            </tr>
            <tr>
                <th>링크</th>
                <td>
                    <input type="text" class="fullWidth" id="devIdTargetUrl" name="targetUrl" maxlength="100" value="">
                </td>
            </tr>
            <tr>
                <th>링크타겟</th>
                <td>
                    <input type="radio" id="devIdTargetYn1" name="targetYn" value="Y" class="devCssRdoIsView" checked="checked">
                    <label for="devIdTargetYn1">같은창</label>

                    <input type="radio" id="devIdTargetYn2" name="targetYn" value="N" class="devCssRdoIsView">
                    <label for="devIdTargetYn2">새창</label>
                </td>
            </tr>

            <tr>
                <th>첨부파일<span class="required">*</span></th>
                <td>
                    <input type="file" id="devIdTxtAttach" name="Attach" value="" accept="image/*">
                    (400*440)
                </td>
            </tr>
            </tbody>
        </table>

        <!-- btnList -->
        <div id="btnList" class="btnList clearfix">
            <button type="button" id="btnSave" class="btn mainBtn">저장</button>
            <button type="button" class="btn blackBtn devCssBtnCancel">취소</button>
        </div>
        <!-- //btnList -->

    </form>

    <script>
        /* 서머노트 초기화 함수 */
        $('#devIdTxtAttach').change(function (e) {
            fileCheck(e.target);
        });

        $('.devCssBtnCancel').click(function(){
            location.href='/page/admin/popup/list';
        });


        $("#btnSave").click(function(){

            var data = new FormData();

            if(tms.isEmpty($('#devIdTxtTitle').val())){
                alert('팝업명을 입력해 주세요.');
                return;
            }

            var chk = $("input:checkbox[id='unLimitYn']").is(":checked");
            var isA = 'N';
            if(chk){
                isA='Y';
            }else{
                if(tms.isEmpty($('#devIdTxtSdt').val())){
                    alert('예약일을 입력해 주세요.');
                    return;
                }
                if(tms.isEmpty($('#devIdTxtEdt').val())){
                    alert('예약일을 입력해 주세요.');
                    return;
                }
            }

            var stDt = $(".dt").eq(0).val();
            var endDt = $(".dt").eq(1).val();
            if(tms.isNotEmpty(stDt) && tms.isNotEmpty(endDt)){
                stDt = stDt.replace(/\-|\s|\:/g,'');
                endDt = endDt.replace(/\-|\s|\:/g,'');

                if(stDt > endDt){
                    alert("시작일은 작성일보다 이전일 수 없습니다.");
                    return;
                }
            }

            data.append("popupNm", $('#devIdTxtTitle').val());
            data.append("viewYn", $(":input:radio[name=viewYn]:checked").val());
            data.append("viewUnlimitYn", isA );

            var sdt = $('#devIdTxtSdt').val();
            var edt = $('#devIdTxtEdt').val();
            if(tms.isNotEmpty( sdt )){ data.append("viewStDt", sdt ); }
            if(tms.isNotEmpty( edt )){ data.append("viewEndDt", edt ); }

            data.append("targetUrl", $('#devIdTargetUrl').val());
            data.append("targetYn", $(":input:radio[name=targetYn]:checked").val());

            var f1 = $('#devIdTxtAttach')[0].files[0];
            if(f1 != null && f1 != ''){
                if(!tms.checkFileExtensionImage(f1.name)) {
                    alert("이미지 파일만 업로드 가능합니다.");
                    return;
                }
                data.append("file", f1 );
            }

            var url = "/mapi/popup";
            var info = tms.getParameterByName("info");

            if(tms.isNotEmpty(info)){
                url = "/mapi/popup/edit";
                data.append("popupSeq", info );
            } else {
                if(f1 == null || f1.name == "") {
                    alert('파일을 업로드해 주세요.');
                    return;
                }
            }

            if(tms.isNotEmpty($('#devIdFileSeq').val())){
                data.append("attachSeq", $('#devIdFileSeq').val() );
            }

            if(!confirm("저장하시겠습니까?")) {
                return;
            }

            tms.ajaxMulitpartHelper(url, data, null, function(result){
                if(result.code == 0){
                    tms.initInputTxt('#inputFrm');
                    alert("저장되었습니다");
                    location.href = "/page/admin/popup/list"
                } else if(result.code == 350){
                    alert("최대 3개가지 노출가능합니다.");
                } else if(result.code == 450){
                    alert("이미지 파일만 업로드 가능합니다.");
                } else {
                    alert("저장중 에러가 발생하였습니다");
                }
            }, function(){
                alert("저장중 에러 발생");
            });
        });

        function detail(info){

            var params = { popupSeq:info };

            tms.ajaxGetHelper('/mapi/popup/detail', params, null, function(rs) {
                if(rs.code==0){
                    var d = rs.data.popup;
                    var fileObj = rs.data.flist;

                    $('#devIdTxtTitle').val(tms.convertHtml(d.popupNm));

                    $('input:radio[name=viewYn]:input[value=' + d.viewYn + ']').attr("checked", true);
                    if(d.viewUnlimitYn == 'Y'){
                        $('input:checkbox[id="unLimitYn"]').attr("checked", true);
                    }
                    $('#devIdTxtSdt').val(d.viewStDt);
                    $('#devIdTxtEdt').val(d.viewEndDt);

                    $('#devIdTargetUrl').val(d.targetUrl);
                    $('input:radio[name=targetYn]:input[value=' + d.targetYn + ']').attr("checked", true);

                    $('#thumbnailSeq').val(d.thumbnailSeq);
                    $('#attachSeq').val(d.attachSeq);

                    if(fileObj != null){
                        var fl = fileObj;
                        for(var i in fl){
                            $('#devIdTxtAttach').after('<br>' +
                                '<input type="hidden" id="devIdFileSeq" value="'+fl[i].fileSeq+'"/>'+
                                '<a href="/api/file/download?fileSeq='+fl[i].fileSeq+'&category=1">'+fl[i].orgFileNm+'</a>');
                        }
                    }
                }
            }, function(){

            });

        }

        $(document).ready(function () {

            $('#devIdTxtSdt,#devIdTxtEdt').datetimepicker({
                dateFormat: "yy-mm-dd"
                ,onClose: function() {
                    $('.note-toolbar').css({'zIndex':500});
                }
                ,beforeShow:function () {
                    $('.note-toolbar').css({'zIndex':0});
                }
            });

            var info = tms.getParameterByName("info");
            if(info != null && info != ''){
                detail(info);

                $('#btnList').append('<button type="button" class="btn grayBtn deleteBtn">삭제</button>');
                $('#btnList .deleteBtn').click(function(e){
                    e.preventDefault();
                    if(confirm('삭제하시겠습니까?')){
                        var infoSeq = tms.getParameterByName("info");
                        var data ={};
                        if(tms.isEmpty(infoSeq)){return ;}
                        data.popupSeq = infoSeq;

                        tms.ajaxDeleteHelper('/mapi/popup', JSON.stringify(data), null, function(rs){
                            if(rs.code==0){
                                alert('삭제되었습니다.');
                                location.href='/page/admin/popup/list';
                            }
                        });
                    }
                });
            }

            $("#unLimitYn").change(function() {
                var chk = $("input:checkbox[id='unLimitYn']").is(":checked");
                if(chk) {
                    $("#devIdTxtSdt").val("");
                    $("#devIdTxtEdt").val("");
                    $("#devIdTxtSdt").attr("disabled", true);
                    $("#devIdTxtEdt").attr("disabled", true);
                } else {
                    $("#devIdTxtSdt").attr("disabled", false);
                    $("#devIdTxtEdt").attr("disabled", false);
                }
            });
        });
    </script>
</div>
</html>